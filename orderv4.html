<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>×”×–×× ×ª ××§×•× ×‘×¤× ×¡×™×•×Ÿ</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/616/616408.png" type="image/png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      direction: rtl;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 16px;
      opacity: 0.9;
    }

    .form-content {
      padding: 40px 30px;
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
    }

    .step-indicator::before {
      content: '';
      position: absolute;
      top: 20px;
      right: 0;
      left: 0;
      height: 2px;
      background: #e0e0e0;
      z-index: 0;
    }

    .step {
      position: relative;
      z-index: 1;
      text-align: center;
      flex: 1;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #999;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 8px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .step.active .step-circle {
      background: #667eea;
      color: white;
      transform: scale(1.1);
    }

    .step.completed .step-circle {
      background: #4caf50;
      color: white;
    }

    .step-label {
      font-size: 12px;
      color: #999;
      font-weight: 500;
    }

    .step.active .step-label {
      color: #667eea;
      font-weight: 600;
    }

    .form-step {
      display: none;
    }

    .form-step.active {
      display: block;
      animation: fadeIn 0.4s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .form-group {
      margin-bottom: 24px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }

    input, select, textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s;
      background: white;
      color: #333;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }

    button {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #666;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .summary-box {
      background: #f8f9ff;
      border: 2px solid #667eea;
      border-radius: 16px;
      padding: 24px;
      margin-top: 20px;
    }

    .summary-box h3 {
      color: #667eea;
      margin-bottom: 16px;
      font-size: 18px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-label {
      color: #666;
      font-weight: 500;
    }

    .summary-value {
      color: #333;
      font-weight: 600;
      text-align: left;
      word-break: keep-all;
      white-space: nowrap;
    }

    .success-message {
      text-align: center;
      padding: 40px 20px;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      background: #4caf50;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      margin: 0 auto 20px;
    }

    .success-message h2 {
      color: #4caf50;
      margin-bottom: 12px;
    }

    .success-message p {
      color: #666;
      font-size: 16px;
      line-height: 1.6;
    }

    .date-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .radio-group {
      display: flex;
      gap: 12px;
    }

    .radio-group-4 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .radio-group-neuter {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    @media (min-width: 500px) {
      .radio-group-4 {
        grid-template-columns: repeat(4, 1fr);
      }

      .radio-group-neuter {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .radio-option {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
    }

    .radio-option:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .radio-option input[type="radio"] {
      display: none;
    }

    .radio-option:has(input[type="radio"]:checked) {
      background: #667eea;
      border-color: #667eea;
    }

    .radio-label {
      font-weight: 600;
      font-size: 16px;
      color: #333;
      transition: color 0.3s;
      text-align: center;
      line-height: 1.3;
    }

    .radio-label small {
      font-size: 12px;
      font-weight: 400;
      opacity: 0.8;
    }

    .radio-option:has(input[type="radio"]:checked) .radio-label {
      color: white;
    }

    .required::after {
      content: '*';
      color: #f44336;
      margin-right: 4px;
    }

    .dog-selection-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }

    .dog-button {
      padding: 16px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 16px;
      font-weight: 600;
      text-align: right;
      color: #333;
    }

    .dog-button:hover {
      border-color: #667eea;
      background: #f8f9ff;
      transform: translateY(-2px);
    }

    .dog-button.selected {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .dog-button-icon {
      margin-left: 8px;
      font-size: 18px;
    }

    .new-dog-button {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: white;
      border: 2px solid #4caf50;
    }

    .new-dog-button:hover {
      background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
      border-color: #45a049;
      transform: translateY(-2px);
    }

    .helper-text {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
    }

    .days-display {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      text-align: center;
      font-size: 18px;
      font-weight: 700;
      margin-top: 16px;
      display: none;
      animation: fadeIn 0.4s;
    }

    .days-display.show {
      display: block;
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      .header {
        padding: 30px 20px;
      }

      .header h1 {
        font-size: 24px;
      }

      .form-content {
        padding: 30px 20px;
      }

      .date-group {
        grid-template-columns: 1fr;
      }

      .step-label {
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>×”×–×× ×ª ××§×•× ×‘×¤× ×¡×™×•×Ÿ</h1>
      <p>××œ××• ××ª ×”×¤×¨×˜×™× ×‘×©×œ×•×©×” ×©×œ×‘×™× ×¤×©×•×˜×™×</p>
    </div>

    <div class="form-content">
      <div class="step-indicator">
        <div class="step active" data-step="0">
          <div class="step-circle">ğŸ‘¤</div>
          <div class="step-label">×–×™×”×•×™</div>
        </div>
        <div class="step" data-step="1">
          <div class="step-circle">1</div>
          <div class="step-label">×¤×¨×˜×™ ×”×‘×¢×œ×™×</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-circle">2</div>
          <div class="step-label">×¤×¨×˜×™ ×”×›×œ×‘</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-circle">3</div>
          <div class="step-label">×ª××¨×™×›×™×</div>
        </div>
      </div>

      

      <div id="bookingForm">
        <div class="form-step active" data-step="0">
          <div class="form-group">
            <label class="required">××¡×¤×¨ ×˜×œ×¤×•×Ÿ</label>
            <input type="tel" id="identificationPhone" placeholder="050-1234567" required />
            <div class="helper-text">×”×–×Ÿ ××ª ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×©×œ×š ×•×œ×—×¥ Enter ××• ×”××©×š ×œ××˜×”</div>
          </div>
          <div id="searchingIndicator" style="display: none; text-align: center; margin: 20px 0; color: #667eea; font-weight: 600;">
            <div style="display: inline-block; animation: spin 1s linear infinite;">â³</div>
            ××—×¤×© ×”×–×× ×•×ª ×§×•×“××•×ª...
          </div>
          <div id="previousDogsContainer" style="display: none; margin-top: 20px;">
            <label class="required">××¦×× ×• ××ª ×”×›×œ×‘×™× ×©×œ×š! ×‘×—×¨ ×›×œ×‘:</label>
            <div id="dogSelectionButtons" class="dog-selection-buttons"></div>
          </div>
        </div>

        <div class="form-step" data-step="1">
          <div class="form-group">
            <label class="required">×©× ××œ×</label>
            <input type="text" name="ownerName" placeholder="×œ×“×•×’××”: ×™×•×¡×™ ×›×”×Ÿ" required />
          </div>
          <div class="button-group">
            <button type="button" class="btn-primary" onclick="nextStep()">×”××©×š â†’</button>
          </div>
        </div>

        <div class="form-step" data-step="2">
          <div class="form-group">
            <label class="required">×©× ×”×›×œ×‘</label>
            <input type="text" name="dogName" placeholder="×œ×“×•×’××”: ××§×¡" required />
          </div>
          <div class="form-group">
            <label class="required">×’×™×œ ×”×›×œ×‘</label>
            <div class="radio-group radio-group-4">
              <label class="radio-option">
                <input type="radio" name="dogAge" value="×’×•×¨ (×¢×“ ×©× ×”)" required />
                <span class="radio-label">×’×•×¨<br><small>×¢×“ ×©× ×”</small></span>
              </label>
              <label class="radio-option">
                <input type="radio" name="dogAge" value="×¦×¢×™×¨ (1-3)" required />
                <span class="radio-label">×¦×¢×™×¨<br><small>1-3</small></span>
              </label>
              <label class="radio-option">
                <input type="radio" name="dogAge" value="×‘×•×’×¨ (4-7)" required />
                <span class="radio-label">×‘×•×’×¨<br><small>4-7</small></span>
              </label>
              <label class="radio-option">
                <input type="radio" name="dogAge" value="××‘×•×’×¨ (8+)" required />
                <span class="radio-label">××‘×•×’×¨<br><small>8+</small></span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label class="required">×’×•×“×œ ×”×›×œ×‘</label>
            <div class="radio-group radio-group-4">
              <label class="radio-option">
                <input type="radio" name="dogSize" value="×§×˜×Ÿ" required />
                <span class="radio-label">×§×˜×Ÿ<br><small>×¢×“ 10 ×§"×’</small></span>
              </label>
              <label class="radio-option">
                <input type="radio" name="dogSize" value="×‘×™× ×•× ×™" required />
                <span class="radio-label">×‘×™× ×•× ×™<br><small>10-25 ×§"×’</small></span>
              </label>
              <label class="radio-option">
                <input type="radio" name="dogSize" value="×’×“×•×œ" required />
                <span class="radio-label">×’×“×•×œ<br><small>25-40 ×§"×’</small></span>
              </label>
              <label class="radio-option">
                <input type="radio" name="dogSize" value="×¢× ×§" required />
                <span class="radio-label">×¢× ×§<br><small>40+ ×§"×’</small></span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label class="required">××™×Ÿ ×•×¡×™×¨×•×¡/×¢×™×§×•×¨</label>
            <div class="radio-group radio-group-neuter">
              <label class="radio-option">
                <input type="radio" name="neutered" value="××¡×•×¨×¡" required />
                <span class="radio-label">××¡×•×¨×¡<br><small>(×–×›×¨)</small></span>
              </label>
              <label class="radio-option">
                <input type="radio" name="neutered" value="××¢×•×§×¨×ª" required />
                <span class="radio-label">××¢×•×§×¨×ª<br><small>(× ×§×‘×”)</small></span>
              </label>
              <label class="radio-option">
                <input type="radio" name="neutered" value="×œ× ××¡×•×¨×¡" required />
                <span class="radio-label">×œ× ××¡×•×¨×¡<br><small>(×–×›×¨)</small></span>
              </label>
              <label class="radio-option">
                <input type="radio" name="neutered" value="×œ× ××¢×•×§×¨×ª" required />
                <span class="radio-label">×œ× ××¢×•×§×¨×ª<br><small>(× ×§×‘×”)</small></span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label>××•×¤×™ ×”×›×œ×‘</label>
            <textarea name="dogTemperament" placeholder="×œ×“×•×’××”: ×™×“×™×“×•×ª×™, ×× ×¨×’×˜×™, ×‘×™×™×©×Ÿ, ×“×•××™× × ×˜×™, ×¨×’×•×¢, ××©×—×§×™, ×—×¨×“×ª×™ ××›×œ×‘×™× ××—×¨×™×..."></textarea>
            <div class="helper-text">×ª××¨ ××ª ×”××•×¤×™ ×•×”×ª× ×”×’×•×ª ×”×›×œ×‘ - ×–×” ×™×¢×–×•×¨ ×œ× ×• ×œ×“××•×’ ×œ×• ×‘×¦×•×¨×” ×”×˜×•×‘×” ×‘×™×•×ª×¨</div>
          </div>
          <div class="form-group">
            <label>×”×¢×¨×•×ª ××™×•×—×“×•×ª</label>
            <textarea name="notes" placeholder="××œ×¨×’×™×•×ª, ×ª×¨×•×¤×•×ª, ×”×ª× ×”×’×•×ª ××™×•×—×“×ª ×•×›×•'"></textarea>
          </div>
          <div class="button-group">
            <button type="button" class="btn-secondary" onclick="prevStep()">â† ×—×–×¨×”</button>
            <button type="button" class="btn-primary" onclick="nextStep()">×”××©×š â†’</button>
          </div>
        </div>

        <div class="form-step" data-step="3">
          <div class="date-group">
            <div class="form-group">
              <label class="required">×ª××¨×™×š ×›× ×™×¡×”</label>
              <input type="date" name="checkIn" id="checkInDate" required />
            </div>
            <div class="form-group">
              <label class="required">×ª××¨×™×š ×™×¦×™××”</label>
              <input type="date" name="checkOut" id="checkOutDate" required />
            </div>
          </div>
          
          <div id="daysDisplay" class="days-display">
            <span id="daysText"></span>
          </div>
          
          <div class="helper-text" style="margin-top: 8px;">
            * ×”×›× ×™×¡×” ×‘×™×Ÿ ×”×©×¢×•×ª 08:00-18:00, ×”×™×¦×™××” ×¢×“ 12:00
          </div>

          <div id="summaryPreview"></div>

          <div class="button-group">
            <button type="button" class="btn-secondary" onclick="prevStep()">â† ×—×–×¨×”</button>
            <button type="button" class="btn-primary" onclick="submitForm()">×©×œ×— ×”×–×× ×” âœ“</button>
          </div>
          <div class="form-group" style="margin-top:24px;">
  <h3 style="color:#667eea; margin-bottom:12px;">×ª×¤×•×¡×ª ×”×¤× ×¡×™×•×Ÿ - 7 ×™××™× ×”×§×¨×•×‘×™×</h3>
  <div id="capacityCalendar" style="display:grid; grid-template-columns: repeat(7,1fr); gap:10px;"></div>
</div>

<script>
async function loadWeeklyCapacity() {
  const MAX_CAPACITY = 15;
  const today = new Date();
  today.setHours(0,0,0,0);

  const endDate = new Date(today);
  endDate.setDate(endDate.getDate() + 6);

  try {
    const { data: orders, error } = await supabase
      .from('orders')
      .select('*')
      .eq('status', '×××•×©×¨')
      .gte('check_out', today.toISOString().split('T')[0])
      .lte('check_in', endDate.toISOString().split('T')[0]);

    if (error) throw error;

    // ×™×¦×™×¨×ª ××¤×ª ×™××™×
    const capacityByDate = {};
    for (let i=0; i<7; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() + i);
      const str = d.toISOString().split('T')[0];
      capacityByDate[str] = 0;
    }

    // ×¡×¤×™×¨×”
    orders.forEach(order => {
      const start = new Date(order.check_in);
      const end = new Date(order.check_out);
      for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
        const str = d.toISOString().split('T')[0];
        if (capacityByDate[str] !== undefined) {
          capacityByDate[str]++;
        }
      }
    });

    // ×‘× ×™×™×ª HTML
    let html = '';
    Object.keys(capacityByDate).forEach(dateStr => {
      const count = capacityByDate[dateStr];
      const perc = (count / MAX_CAPACITY) * 100;
      const d = new Date(dateStr);
      const dayName = d.toLocaleDateString('he-IL', { weekday:'short' });
      const dayNum = d.getDate();
      const month = d.getMonth()+1;

      let bgColor = '#4caf50';
      if (perc >= 80) bgColor = '#ff9800';
      if (perc >= 100) bgColor = '#f44336';

      html += `
        <div style="background:${bgColor}; color:white; border-radius:10px; padding:10px; text-align:center;">
          <div style="font-size:14px; font-weight:700;">${dayNum}/${month}</div>
          <div style="font-size:12px; opacity:0.9;">${dayName}</div>
          <div style="font-size:16px; margin-top:4px;">${count}/${MAX_CAPACITY}</div>
        </div>
      `;
    });

    document.getElementById('capacityCalendar').innerHTML = html;
  } catch (err) {
    console.error("Error loading weekly capacity:", err);
  }
}

// × ×˜×¢×Ÿ ×‘×¨×’×¢ ×©×”×¢××•×“ ××•×›×Ÿ
document.addEventListener('DOMContentLoaded', loadWeeklyCapacity);
</script>
        </div>

        <div class="form-step" data-step="4">
          <div class="success-message">
            <div class="success-icon">âœ“</div>
            <h2>×”×”×–×× ×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!</h2>
            <p>×ª×§×‘×œ×• ××™×©×•×¨ ×‘×”×•×“×¢×ª ×•×•××˜×¡××¤ ×‘×”×§×“×.<br>××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×©×œ× ×•: 052-8366744</p>
            <div id="finalSummary"></div>
            <button type="button" class="btn-primary" onclick="resetForm()" style="margin-top: 24px;">×”×–×× ×” ×—×“×©×”</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://smzgfffeehrozxsqtgqa.supabase.co';
  const SUPABASE_ANON_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtemdmZmZlZWhyb3p4c3F0Z3FhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNTU4NTYsImV4cCI6MjA3NDgzMTg1Nn0.LvIQLvj7HO7xXJhTALLO5GeYZ1DU50L3q8Act5wXfi4';

  const MAKE_WEBHOOK_URL = 'https://hook.eu2.make.com/lbrr9gvt057o2ygrkalkxkri1y4z4ujf';
  const ADMIN_PHONE = '972528366744';

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  let currentStep = 0;
  let previousOrders = [];

  async function sendWhatsAppToMake(payload) {
    try {
      await fetch(MAKE_WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
    } catch (err) {
      console.error('Make webhook error:', err);
    }
  }

  // ========================== ××™×¨×•×¢×™× ×‘×¢×ª ×˜×¢×™× ×” ==========================

  document.addEventListener('DOMContentLoaded', function () {
    const phoneInput = document.getElementById('identificationPhone');

    if (phoneInput) {
      phoneInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          identifyCustomer();
        }
      });

      phoneInput.addEventListener('input', function () {
        const phone = this.value.replace(/[\s\-]/g, '');
        if (phone.length === 10) identifyCustomer();
      });
    }

    const checkInInput = document.getElementById('checkInDate');
    const checkOutInput = document.getElementById('checkOutDate');

    if (checkInInput && checkOutInput) {
      checkInInput.addEventListener('change', updateDaysDisplay);
      checkOutInput.addEventListener('change', updateDaysDisplay);
    }
  });

  // ========================== ×—×™×©×•×‘ ×•×”×¦×’×ª ×™××™× ==========================

  function updateDaysDisplay() {
    const checkIn = document.getElementById('checkInDate').value;
    const checkOut = document.getElementById('checkOutDate').value;
    const daysDisplay = document.getElementById('daysDisplay');
    const daysText = document.getElementById('daysText');

    if (checkIn && checkOut) {
      const days = calculateDays(checkIn, checkOut);
      if (days > 0) {
        daysText.textContent = `ğŸ¾ ×”×›×œ×‘ ×™×©×”×” ×‘×¤× ×¡×™×•×Ÿ ${days} ×™××™×`;
        daysDisplay.classList.add('show');
      } else {
        daysDisplay.classList.remove('show');
      }
    } else {
      daysDisplay.classList.remove('show');
    }
  }

  function calculateDays(checkIn, checkOut) {
    if (!checkIn || !checkOut) return 0;
    const start = new Date(checkIn);
    const end = new Date(checkOut);
    return Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24));
  }

  function formatDateWithDay(dateString) {
    const daysHebrew = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
    const d = new Date(dateString);
    if (isNaN(d)) return '';
    const day = ('0' + d.getDate()).slice(-2);
    const month = ('0' + (d.getMonth() + 1)).slice(-2);
    const year = d.getFullYear();
    return `${day}/${month}/${year} (${daysHebrew[d.getDay()]})`;
  }

  // ========================== ×¡×˜×˜×™× ×©×œ ×©×œ×‘×™× ==========================

  function updateStepIndicator() {
    document.querySelectorAll('.step').forEach((step) => {
      const stepNum = parseInt(step.dataset.step);
      step.classList.remove('active', 'completed');
      if (stepNum === currentStep) step.classList.add('active');
      else if (stepNum < currentStep) step.classList.add('completed');
    });

    document.querySelectorAll('.form-step').forEach((step) => step.classList.remove('active'));
    document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.add('active');
  }

  function validateStep(step) {
    const stepEl = document.querySelector(`.form-step[data-step="${step}"]`);
    const inputs = stepEl.querySelectorAll('input[required]:not([type="radio"]), textarea[required]');
    for (let i of inputs) if (!i.value.trim()) return false;

    const radios = {};
    stepEl.querySelectorAll('input[type="radio"][required]').forEach((r) => {
      if (!radios[r.name]) radios[r.name] = false;
      if (r.checked) radios[r.name] = true;
    });

    return Object.values(radios).every((v) => v === true);
  }

  function nextStep() {
    if (validateStep(currentStep)) {
      if (currentStep === 3) showSummary();
      currentStep++;
      updateStepIndicator();
    }
  }

  function prevStep() {
    currentStep--;
    updateStepIndicator();
  }

  // ========================== ×¡×™×›×•× ==========================

  function showSummary() {
    const data = getFormData();
    const phone = document.getElementById('identificationPhone').value.replace(/[\s\-]/g, '');
    const checkIn = formatDateWithDay(data.checkIn);
    const checkOut = formatDateWithDay(data.checkOut);
    const numDays = calculateDays(data.checkIn, data.checkOut);
    const pricePerDay = 130;
    const totalPrice = numDays * pricePerDay;

    const html = `
      <div class="summary-box">
        <h3>×¡×™×›×•× ×”×”×–×× ×”</h3>
        <div class="summary-item"><span>×©× ×”×‘×¢×œ×™×:</span><span>${data.ownerName}</span></div>
        <div class="summary-item"><span>×˜×œ×¤×•×Ÿ:</span><span>${phone}</span></div>
        <div class="summary-item"><span>×©× ×”×›×œ×‘:</span><span>${data.dogName}</span></div>
        <div class="summary-item"><span>×’×™×œ:</span><span>${data.dogAge}</span></div>
        <div class="summary-item"><span>×’×•×“×œ:</span><span>${data.dogSize}</span></div>
        <div class="summary-item"><span>××™×Ÿ:</span><span>${data.neutered}</span></div>
        <div class="summary-item"><span>×›× ×™×¡×”:</span><span>${checkIn}</span></div>
        <div class="summary-item"><span>×™×¦×™××”:</span><span>${checkOut}</span></div>
        <div class="summary-item"><span>××¡×¤×¨ ×™××™×:</span><span>${numDays}</span></div>
        <div class="summary-item"><span>×¡×”"×›:</span><span>${totalPrice}â‚ª</span></div>
      </div>`;
    document.getElementById('summaryPreview').innerHTML = html;
  }

  function getFormData() {
    const d = {};
    document
      .querySelectorAll(
        '#bookingForm input[type="text"], #bookingForm input[type="tel"], #bookingForm input[type="date"], #bookingForm textarea'
      )
      .forEach((i) => (d[i.name] = i.value));
    document.querySelectorAll('#bookingForm input[type="radio"]:checked').forEach((r) => (d[r.name] = r.value));
    return d;
  }

  // ========================== ×–×™×”×•×™ ×œ×§×•×— ×§×™×™× ==========================

  async function identifyCustomer() {
    const phoneInput = document.getElementById('identificationPhone');
    let phone = phoneInput.value.replace(/[\s\-]/g, '');
    if (!phone || phone.length < 9) return;

    document.getElementById('searchingIndicator').style.display = 'block';
    document.getElementById('previousDogsContainer').style.display = 'none';

    if (/^[1-9]\d{8}$/.test(phone)) phone = '0' + phone;

    try {
      const { data, error } = await supabase
        .from('orders')
        .select('*')
        .eq('phone', phone)
        .order('created_at', { ascending: false });

      if (error) throw error;

      previousOrders = data || [];

      document.getElementById('searchingIndicator').style.display = 'none';

      if (previousOrders.length > 0) {
        const buttonsContainer = document.getElementById('dogSelectionButtons');
        buttonsContainer.innerHTML = '';

        const uniqueDogs = [];
        const dogNames = new Set();

        previousOrders.forEach((order) => {
          if (order.dog_name && !dogNames.has(order.dog_name)) {
            dogNames.add(order.dog_name);
            uniqueDogs.push(order);
          }
        });

        uniqueDogs.forEach((order, index) => {
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'dog-button';
          button.dataset.dogIndex = index;
          button.innerHTML = `<span class="dog-button-icon">ğŸ•</span> ${order.dog_name} (${order.dog_breed ||
            '×’×–×¢ ×œ× ×™×“×•×¢'}, ${order.dog_age || '×’×™×œ ×œ× ×™×“×•×¢'})`;

          button.onclick = function () {
            document.querySelectorAll('.dog-button').forEach((btn) => btn.classList.remove('selected'));
            this.classList.add('selected');

            const selectedDog = uniqueDogs[index];
            document.querySelector('input[name="dogName"]').value = selectedDog.dog_name;

            let radio;
            radio = document.querySelector(`input[name="dogAge"][value="${selectedDog.dog_age}"]`);
            if (radio) radio.checked = true;

            radio = document.querySelector(`input[name="dogSize"][value="${selectedDog.dog_breed}"]`);
            if (radio) radio.checked = true;

            radio = document.querySelector(`input[name="neutered"][value="${selectedDog.neutered}"]`);
            if (radio) radio.checked = true;

            document.querySelector('textarea[name="dogTemperament"]').value =
              selectedDog.dog_temperament || '';
            document.querySelector('textarea[name="notes"]').value = selectedDog.notes || '';

            currentStep = 3;
            updateStepIndicator();
          };

          buttonsContainer.appendChild(button);
        });

        const newDogButton = document.createElement('button');
        newDogButton.type = 'button';
        newDogButton.className = 'dog-button new-dog-button';
        newDogButton.innerHTML = `<span class="dog-button-icon">â•</span> ×›×œ×‘ ×—×“×©`;

        newDogButton.onclick = function () {
          document.querySelectorAll('.dog-button').forEach((btn) => btn.classList.remove('selected'));
          this.classList.add('selected');

          document.querySelector('input[name="dogName"]').value = '';
          document
            .querySelectorAll('input[name="dogAge"], input[name="dogSize"], input[name="neutered"]')
            .forEach((r) => (r.checked = false));
          document.querySelector('textarea[name="dogTemperament"]').value = '';
          document.querySelector('textarea[name="notes"]').value = '';

          currentStep = 2;
          updateStepIndicator();
        };

        buttonsContainer.appendChild(newDogButton);

        window.uniqueDogsData = uniqueDogs;
        document.querySelector('input[name="ownerName"]').value = previousOrders[0].owner_name;
        document.getElementById('previousDogsContainer').style.display = 'block';
      } else {
        document.querySelector('input[name="ownerName"]').value = '';
        currentStep = 1;
        updateStepIndicator();
      }
    } catch (e) {
      console.error('Error fetching orders:', e);
      document.getElementById('searchingIndicator').style.display = 'none';
      alert('×©×’×™××” ×‘×—×™×¤×•×©');
      currentStep = 1;
      updateStepIndicator();
    }
  }

  // ========================== ×©×œ×™×—×ª ×”×”×–×× ×” ==========================

  async function submitForm() {
    if (!validateStep(3)) return;

    const btn = document.querySelector('.form-step[data-step="3"] .btn-primary');
    btn.disabled = true;
    btn.textContent = '×©×•×œ×—...';

    const formData = getFormData();
    const rawPhone = document.getElementById('identificationPhone').value.replace(/[\s\-]/g, '');
    const finalPhone = rawPhone.startsWith('0') ? '972' + rawPhone.substring(1) : rawPhone;

    // ×”×›× ×¡×ª ×”×”×–×× ×” ×œ××¡×“ Supabase
    const { error } = await supabase.from('orders').insert([
      {
        owner_name: formData.ownerName,
        phone: finalPhone,
        check_in: formData.checkIn,
        check_out: formData.checkOut,
        dog_name: formData.dogName,
        dog_age: formData.dogAge,
        dog_breed: formData.dogSize,
        neutered: formData.neutered,
        dog_temperament: formData.dogTemperament || '',
        notes: formData.notes || '',
      },
    ]);

    if (error) {
      alert('×©×’×™××” ×‘×©×œ×™×—×”.');
      btn.disabled = false;
      btn.textContent = '×©×œ×— ×”×–×× ×” âœ“';
      return;
    }

    // ××—×™×¨
    const numDays = calculateDays(formData.checkIn, formData.checkOut);
    const totalPrice = numDays * 130;

    // ×”×•×“×¢×” ×œ×œ×§×•×—
    await sendWhatsAppToMake({
      type: 'customer',
      phone: finalPhone,
      message: `
ğŸ¾ ×”×–×× ×” × ×§×œ×˜×”

×©×œ×•× ${formData.ownerName},

×§×™×‘×œ× ×• ××ª ×”×”×–×× ×” ×¢×‘×•×¨ ${formData.dogName}.

â€¢ ×›× ×™×¡×”: ${formatDateWithDay(formData.checkIn)}
â€¢ ×™×¦×™××”: ${formatDateWithDay(formData.checkOut)}
â€¢ ××¡×¤×¨ ×™××™×: ${numDays}
â€¢ ×’×™×œ: ${formData.dogAge}
â€¢ ×’×•×“×œ: ${formData.dogSize}
â€¢ ××™×Ÿ: ${formData.neutered}

×¢×œ×•×ª ××©×•×¢×¨×ª: ${totalPrice} ×©"×—.

× ×¢×“×›×Ÿ ×›×©×–×” ×™××•×©×¨.
×œ×©××œ×•×ª: 052-8366744
`,
    });

    // ×”×•×“×¢×” ×œ×× ×”×œ
    await sendWhatsAppToMake({
      type: 'admin',
      phone: ADMIN_PHONE,
      message: `
ğŸ”” ×”×–×× ×” ×—×“×©×”

×œ×§×•×—:
${formData.ownerName}
${finalPhone}

×›×œ×‘:
${formData.dogName}, ${formData.dogAge}, ${formData.dogSize}, ${formData.neutered}

×ª××¨×™×›×™×:
${formatDateWithDay(formData.checkIn)} â†’ ${formatDateWithDay(formData.checkOut)}
×¡×”"×›: ${numDays} ×™××™×
×¢×œ×•×ª: ${totalPrice} ×©"×—

${formData.notes ? '×”×¢×¨×•×ª: ' + formData.notes : ''}
`,
    });

    // ××¢×‘×¨ ×œ××¡×š ×¡×™×•×
    currentStep = 4;
    updateStepIndicator();
  }

  // ========================== ××™×¤×•×¡ ==========================

  function resetForm() {
    document
      .querySelectorAll('#bookingForm input, #bookingForm textarea')
      .forEach((i) => (i.type === 'radio' ? (i.checked = false) : (i.value = '')));

    document.getElementById('previousDogsContainer').style.display = 'none';
    document.getElementById('summaryPreview').innerHTML = '';
    document.getElementById('finalSummary').innerHTML = '';
    document.getElementById('daysDisplay').classList.remove('show');

    currentStep = 0;
    updateStepIndicator();
  }
</script>
</body>
</html>
